<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Dashboard V2</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styling for metric cards */
        .metric-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease;
            border-radius: 0.75rem; /* rounded-xl equivalent */
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        /* Styling for responsive chart container */
        .ring-chart-container {
            position: relative;
            width: 100%;
            /* 1:1 Aspect Ratio for responsiveness */
            padding-bottom: 100%; 
            
            /* Centering fix: Use Flexbox on the parent to center the content */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .ring-chart-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .filter-select {
            @apply p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm;
        }
        /* Style for the sortable column headers */
        th.cursor-pointer:hover {
            background-color: #f1f5f9; /* light blue-gray hover */
        }
    </style>
    <!-- Load Chart.js for the ring chart --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- REMOVED: Data Labels Plugin (Using Legend for stability) --></head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Portfolio Overview</h1>

        <!-- Owner Filter (Global Control) --><div class="mb-6 bg-white p-4 rounded-xl shadow-md flex flex-col sm:flex-row items-center gap-4">
            <label for="ownerFilter" class="text-sm font-semibold text-gray-700 whitespace-nowrap">Filter by Owner:</label>
            <select id="ownerFilter" class="filter-select w-full sm:w-auto min-w-[150px]">
                <option value="All">All Owners</option>
                <!-- Owner options populated by JS --></select>
            <div id="loadingStatus" class="text-sm text-indigo-500 ml-auto hidden">Loading...</div>
        </div>

        <!-- Main Dynamic Content Area --><!-- Default grid is 1 column on mobile, 3 on desktop. Will be dynamically changed to 2 columns if a Tag is selected --><div id="mainContentGrid" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- Ring Chart Card (Always visible, content changes) --><div id="chartCard" class="bg-white p-6 rounded-xl metric-card shadow-lg lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2" id="chartTitle">Allocation by Tag</h2>
                <div class="ring-chart-container">
                    <canvas id="allocationChart" class="ring-chart-canvas"></canvas>
                </div>
            </div>

            <!-- Key Financial Metrics Cards (Hidden when Tag filter is active) --><div id="keyMetricsWrapper" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-2 gap-4 lg:col-span-2 transition-opacity duration-300">
                <div id="metric-invested" class="metric-card bg-white p-5 border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500">Total Invested</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1" id="totalInvested">Loading...</p>
                </div>
                <div id="metric-value" class="metric-card bg-white p-5 border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-500">Current Value</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1" id="currentValue">Loading...</p>
                </div>
                <div id="metric-return" class="metric-card bg-white p-5 border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-500">Total Return</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1" id="totalReturn">Loading...</p>
                </div>
                <div id="metric-xirr" class="metric-card bg-white p-5 border-l-4 border-red-500">
                    <p class="text-sm font-medium text-gray-500">Overall XIRR</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1" id="overallXirr">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Detailed Fund Table (Always spans full width but is visually alongside chart when Tag is filtered) --><div class="bg-white p-6 rounded-xl metric-card shadow-lg" id="fundDetailsCard">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Fund Details</h2>
            <div class="p-8 text-center text-lg text-indigo-500">Loading portfolio data from Google Sheets...</div>
        </div>
    </div>

    <script>
        // --- DATA SOURCE CONFIGURATION ---
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5ozzUpj35PGfBGKsdwKhviBFogErmsLxcKaLWJ_rbxDcPLI1LPUxp6EwpLjEQWyIbvMs2RT8VI6MH/pub?gid=1275914219&single=true&output=csv'; 
        
        let fundData = []; 
        let allocationChart = null;
        let tableSort = { prop: 'returnPct', order: 'desc' };

        // --- FILTER STATE ---
        let currentOwner = 'All';
        let currentTag = 'All';


        // --- UTILITY FUNCTIONS (Formatting) ---

        const isFileProtocol = () => window.location.protocol === 'file:';

        const formatCurrency = (amount) => {
            if (isNaN(amount) || amount === null) return '₹ 0';
            return new Intl.NumberFormat('en-IN', { 
                style: 'currency', 
                currency: 'INR', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        const formatUnits = (amount) => {
             if (isNaN(amount) || amount === null) return '0.00';
             return new Intl.NumberFormat('en-US', { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        const formatPercent = (value) => {
            if (isNaN(value) || value === null) return '0.0%';
            return (value * 100).toFixed(1) + '%';
        };

        // --- CORE CSV PARSING FUNCTION ---
        
        function splitCSVLine(line) {
            const results = [];
            let currentField = '';
            let inQuote = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    results.push(currentField.trim().replace(/['"]+/g, ''));
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            results.push(currentField.trim().replace(/['"]+/g, ''));
            return results;
        }


        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const [headerLine, ...dataLines] = lines;
            const headers = headerLine.split(',').map(h => h.trim().replace(/['"]+/g, ''));
            
            const propMap = {
                'Owner': 'owner', 'Tag': 'tag', 'Scheme Name': 'schemeName', 'Units': 'units',
                'Invested': 'invested', 'Value': 'value', 'Return': 'returns', 'Return %': 'returnPct', 'XIRR': 'xirr',
            };
            
            const standardNumericProps = ['units', 'invested', 'value', 'returns'];
            const percentageProps = ['returnPct', 'xirr'];

            const headerToProp = headers.map(h => {
                const propKey = Object.keys(propMap).find(key => key.toLowerCase() === h.toLowerCase());
                return propMap[propKey] || null;
            }).filter(Boolean);

            const schemeNameIndex = headers.findIndex(h => h.toLowerCase() === 'scheme name');
            
            return dataLines.map(line => {
                const values = splitCSVLine(line); 
                const fund = {};

                if (schemeNameIndex === -1 || !values[schemeNameIndex] || values[schemeNameIndex].trim() === '') {
                    return null;
                }

                values.forEach((rawValue, index) => {
                    const prop = headerToProp[index];
                    if (!prop) return;

                    let cleanedValue = rawValue.replace(/[$,₹]/g, '').trim();
                    
                    if (standardNumericProps.includes(prop) || percentageProps.includes(prop)) {
                         cleanedValue = cleanedValue.replace(/,/g, '').replace(/%/g, '');
                    }
                    
                    const parsedValue = parseFloat(cleanedValue) || 0;
                    
                    if (standardNumericProps.includes(prop)) {
                        fund[prop] = parsedValue;
                    } else if (percentageProps.includes(prop)) {
                        fund[prop] = parsedValue / 100;
                    } else {
                        fund[prop] = cleanedValue;
                    }
                });

                if (!fund.owner || !fund.tag || !fund.schemeName) return null;
                
                return fund;
            }).filter(f => f); 
        }

        // --- FILTERING & RENDERING COORDINATION ---

        function getFilteredData(owner, tag) {
            let filtered = fundData;
            
            if (owner !== 'All') {
                filtered = filtered.filter(f => f.owner === owner);
            }

            if (tag !== 'All') {
                filtered = filtered.filter(f => f.tag === tag);
            }

            return filtered;
        }
        
        function getFilteredDataForMetrics(owner) {
            return getFilteredData(owner, 'All');
        }

        function updateDashboard() {
            // Read current filter state
            currentOwner = document.getElementById('ownerFilter').value;
            currentTag = document.getElementById('tagFilter') ? document.getElementById('tagFilter').value : 'All';
            
            // 1. Data for Metrics and Chart (only filtered by Owner)
            const metricsChartData = getFilteredDataForMetrics(currentOwner);
            
            // 2. Data for Table (filtered by Owner and Tag, and searched)
            let tableData = getFilteredData(currentOwner, currentTag);
            tableData = filterSearch(tableData);

            // 3. Dynamic Layout Switch
            const mainGrid = document.getElementById('mainContentGrid');
            const metricsWrapper = document.getElementById('keyMetricsWrapper');
            const chartCard = document.getElementById('chartCard');
            const fundDetailsCard = document.getElementById('fundDetailsCard');


            if (currentTag !== 'All') {
                // Detailed Tag View (Chart on Left, Table on Right)
                metricsWrapper.classList.add('hidden', 'opacity-0');
                mainGrid.classList.remove('lg:grid-cols-3');
                mainGrid.classList.add('lg:grid-cols-2');
                
                // Move table visually next to chart (adjust CSS class for two columns)
                chartCard.classList.remove('lg:col-span-1');
                chartCard.classList.add('lg:col-span-1');
                fundDetailsCard.classList.remove('lg:col-span-3'); // Reset existing
                fundDetailsCard.classList.add('lg:col-span-1', 'order-2'); // Makes table appear right of chart
                
            } else {
                // Overview View (Chart + Metrics)
                metricsWrapper.classList.remove('hidden', 'opacity-0');
                mainGrid.classList.remove('lg:grid-cols-2');
                mainGrid.classList.add('lg:grid-cols-3');
                
                chartCard.classList.remove('lg:col-span-2');
                chartCard.classList.add('lg:col-span-1');
                fundDetailsCard.classList.remove('lg:col-span-1', 'order-2'); // Reset layout
            }


            // 4. Update all visual components
            calculateOverallMetrics(metricsChartData);
            createRingChart(metricsChartData); // Pass the owner-filtered data
            applySort(tableData);
        }


        // --- DATA BINDING AND VISUALIZATION ---

        function populateFilters() {
            const uniqueOwners = [...new Set(fundData.map(f => f.owner))].sort();
            const ownerFilter = document.getElementById('ownerFilter');
            
            ownerFilter.innerHTML = '<option value="All">All Owners</option>';
            uniqueOwners.forEach(owner => {
                ownerFilter.innerHTML += `<option value="${owner}" ${owner === currentOwner ? 'selected' : ''}>${owner}</option>`;
            });
            
            populateTagFilter();
        }

        function populateTagFilter() {
            const uniqueTags = [...new Set(fundData.map(f => f.tag))].sort();
            const tagFilter = document.getElementById('tagFilter');

            if (tagFilter) {
                 tagFilter.innerHTML = '<option value="All">All Tags</option>';
                 uniqueTags.forEach(tag => {
                    tagFilter.innerHTML += `<option value="${tag}" ${tag === currentTag ? 'selected' : ''}>${tag}</option>`;
                 });
            }
        }
        
        function calculateOverallMetrics(data) {
            const totalInvested = data.reduce((sum, fund) => sum + fund.invested, 0);
            const currentValue = data.reduce((sum, fund) => sum + fund.value, 0);
            const totalReturn = currentValue - totalInvested;
            
            const overallXIRR = (data.reduce((sum, fund) => sum + fund.xirr * fund.invested, 0) / totalInvested) || 0; 

            document.getElementById('totalInvested').textContent = formatCurrency(totalInvested);
            document.getElementById('currentValue').textContent = formatCurrency(currentValue);
            document.getElementById('totalReturn').textContent = formatCurrency(totalReturn);
            document.getElementById('overallXirr').textContent = formatPercent(overallXIRR);

            const returnElement = document.getElementById('metric-return');
            returnElement.classList.remove('border-yellow-500', 'border-green-500', 'border-red-500');
            
            if (totalReturn > 0) {
                returnElement.classList.add('border-green-500');
            } else if (totalReturn < 0) {
                returnElement.classList.add('border-red-500');
            } else {
                returnElement.classList.add('border-yellow-500');
            }
        }

        function createRingChart(data) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            const chartTitle = document.getElementById('chartTitle');
            
            if (allocationChart) {
                allocationChart.destroy();
            }

            let chartDataRaw = [];
            let chartLabels = [];
            let chartInvested = [];
            let chartValues = [];
            let totalChartValue = 0;

            if (currentTag === 'All') {
                // Mode 1: Group by Tag (Metrics View)
                chartTitle.textContent = 'Allocation by Tag (Filtered by Owner)';
                const tagAllocation = data.reduce((acc, fund) => {
                    const tag = fund.tag;
                    acc[tag] = {
                        value: (acc[tag]?.value || 0) + fund.value,
                        invested: (acc[tag]?.invested || 0) + fund.invested
                    };
                    return acc;
                }, {});
                
                chartDataRaw = Object.entries(tagAllocation).filter(([, d]) => d.value > 0);
                chartLabels = chartDataRaw.map(([tag]) => tag);
                chartValues = chartDataRaw.map(([, d]) => d.value);
                chartInvested = chartDataRaw.map(([, d]) => d.invested);

            } else {
                // Mode 2: Group by Scheme Name (Detail View)
                chartTitle.textContent = `Allocation by Scheme Name (${currentTag})`;
                const filteredDataForScheme = fundData.filter(f => f.owner === currentOwner && f.tag === currentTag);

                const schemeAllocation = filteredDataForScheme.reduce((acc, fund) => {
                    const scheme = fund.schemeName;
                    acc[scheme] = {
                        value: (acc[scheme]?.value || 0) + fund.value,
                        invested: (acc[scheme]?.invested || 0) + fund.invested
                    };
                    return acc;
                }, {});

                chartDataRaw = Object.entries(schemeAllocation).filter(([, d]) => d.value > 0);
                chartLabels = chartDataRaw.map(([scheme]) => scheme);
                chartValues = chartDataRaw.map(([, d]) => d.value);
                chartInvested = chartDataRaw.map(([, d]) => d.invested);
            }

            totalChartValue = chartValues.reduce((sum, val) => sum + val, 0);

            const generateColors = (count) => {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    colors.push(`hsl(${(i * 50 + 120) % 360}, 70%, 50%)`);
                }
                return colors;
            };
            
            const generatedColors = generateColors(chartLabels.length);

            const datasets = [{
                data: chartValues,
                backgroundColor: generatedColors, 
                hoverOffset: 8,
                investedValues: chartInvested, 
                values: chartValues
            }];
            
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', 
                    layout: {
                        padding: 10 // Small padding for internal canvas area
                    },
                    plugins: {
                        legend: {
                            display: true, // RE-ENABLED LEGEND
                            position: 'right',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 11
                                },
                                // ENHANCED LEGEND CALLBACK: Shows label name and percentage
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const value = data.datasets[0].data[i];
                                            const percentage = total > 0 ? (value / total) * 100 : 0;
                                            
                                            return {
                                                text: `${label} (${percentage.toFixed(1)}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: data.datasets[0].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const invested = context.dataset.investedValues[context.dataIndex];
                                    const percentage = totalChartValue > 0 ? (value / totalChartValue) * 100 : 0;
                                    
                                    return [
                                        `${label}: ${formatPercent(percentage / 100)}`, 
                                        `Value: ${formatCurrency(value)}`,           
                                        `Invested: ${formatCurrency(invested)}`       
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('fundTableBody');
            if (!tbody) return; 
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan='7' class='px-3 py-4 text-center text-sm text-gray-500'>No funds match the selected criteria.</td></tr>`;
                return;
            }

            data.forEach(fund => {
                const returnClass = fund.returns >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-150 ease-in-out';
                row.innerHTML = `
                    <td class='px-3 py-4 text-left text-sm font-medium text-gray-900'>${fund.schemeName}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-right'>${formatUnits(fund.units)}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right'>${formatCurrency(fund.invested)}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right'>${formatCurrency(fund.value)}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm text-gray-900 text-right'>${formatCurrency(fund.returns)}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm ${returnClass} text-right'>${formatPercent(fund.returnPct)}</td>
                    <td class='px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-right'>${formatPercent(fund.xirr)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- FILTERING & SORTING LOGIC ---

        function filterSearch(data) {
             const schemeSearch = document.getElementById('schemeSearch');
             if (!schemeSearch) return data;
             const searchValue = schemeSearch.value.toLowerCase();
             return data.filter(fund => fund.schemeName.toLowerCase().includes(searchValue));
        }

        function applySort(data) {
            
            data.sort((a, b) => {
                const aVal = a[getPropName(tableSort.prop)];
                const bVal = b[getPropName(tableSort.prop)];
                
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                else if (aVal < bVal) comparison = -1;
                else comparison = 0;

                return tableSort.order === 'desc' ? comparison * -1 : comparison;
            });

            // Highlight sorted column header
            const headers = document.querySelectorAll('#fundDetailsCard th');
            headers.forEach(header => {
                const headerProp = header.getAttribute('data-sort');
                header.classList.remove('font-extrabold', 'text-indigo-600', 'text-gray-900');
                if (headerProp === tableSort.prop) {
                    header.classList.add('font-extrabold', 'text-indigo-600');
                } else {
                    header.classList.add('text-gray-500');
                }
            });

            renderTable(data);
        }

        function getPropName(key) {
            switch(key) {
                case 'scheme': return 'schemeName';
                case 'units': return 'units';
                case 'invested': return 'invested';
                case 'value': return 'value';
                case 'return': return 'returns'; 
                case 'return_pct': return 'returnPct';
                case 'xirr': return 'xirr';
                default: return key;
            }
        }

        window.sortTable = function(property) {
            const newProp = getPropName(property);
            
            if (tableSort.prop === newProp) {
                tableSort.order = tableSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                tableSort.prop = newProp;
                tableSort.order = 'desc'; 
            }
              
            updateDashboard();
        }
        
        // --- DATA FETCHING & INITIALIZATION ---
        
        function getErrorMessage(message) {
            return `<h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Fund Details</h2><div class="p-8 text-center text-lg text-red-500">${message}</div>`;
        }

        function getOriginalTableStructure() {
            return `
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Fund Details</h2>
                <div class="mb-4 flex flex-col sm:flex-row gap-3">
                    <select id="tagFilter" class="filter-select w-full sm:w-auto min-w-[150px]" onchange="updateDashboard()">
                        <option value="All">Filter by Tag</option>
                    </select>
                    <input type="text" id="schemeSearch" placeholder="Search Scheme Name..." 
                           class="p-3 border border-gray-300 rounded-lg w-full sm:w-1/3 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                           oninput="updateDashboard()"
                           >
                    <!-- No sort dropdown needed, sorting is via table headers --></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" data-sort="scheme" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('scheme')">Scheme Name</th>
                                <th scope="col" data-sort="units" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('units')">Units</th>
                                <th scope="col" data-sort="invested" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('invested')">Invested</th>
                                <th scope="col" data-sort="value" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('value')">Value</th>
                                <th scope="col" data-sort="return" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('return')">Return</th>
                                <th scope="col" data-sort="return_pct" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('return_pct')">Return %</th>
                                <th scope="col" data-sort="xirr" class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('xirr')">XIRR</th>
                            </tr>
                        </thead>
                        <tbody id="fundTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected here --></tbody>
                    </table>
                </div>
            `;
        }

        const setupListeners = () => {
            const ownerFilter = document.getElementById('ownerFilter');
            if (ownerFilter) ownerFilter.addEventListener('change', updateDashboard);
            // Tag filter and search handlers are now inline in getOriginalTableStructure
        };
        
        async function fetchAndProcessData() {
            document.getElementById('loadingStatus').classList.remove('hidden');

            if (isFileProtocol()) {
                 document.getElementById('fundDetailsCard').innerHTML = getErrorMessage('Data Fetch Error: The browser prevents data fetching from external URLs when the HTML file is opened directly (using `file://`). Please run this file using a local web server.');
                 return;
            }
            
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const csvText = await response.text();
                
                fundData = parseCSV(csvText);

                if (fundData.length === 0) {
                    document.getElementById('fundDetailsCard').innerHTML = getErrorMessage('No data found. Check your Google Sheet URL/format or if the sheet is empty.');
                    return;
                }

                document.getElementById('fundDetailsCard').innerHTML = getOriginalTableStructure();
                
                setupListeners();
                populateFilters(); // Needs to run after listeners are set up for dynamic elements
                
                updateDashboard();

            } catch (error) {
                console.error('Error fetching or processing data:', error);
                document.getElementById('fundDetailsCard').innerHTML = getErrorMessage('Failed to load data. Please confirm the SHEET_URL is correct and published publicly.');
                
                document.getElementById('totalInvested').textContent = formatCurrency(0);
                document.getElementById('currentValue').textContent = formatCurrency(0);
                document.getElementById('totalReturn').textContent = formatCurrency(0);
                document.getElementById('overallXirr').textContent = formatPercent(0);
            } finally {
                document.getElementById('loadingStatus').classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAndProcessData);
    </script>
</body>
</html>
